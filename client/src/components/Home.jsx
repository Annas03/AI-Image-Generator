import React, { useEffect, useRef } from 'react'
import { useState } from 'react'
import {loader} from '../assets/index'
import ShowCase from './ShowCase'
import { Pagination } from 'antd';

const Home = ({images, setImages}) => {
  const [imgList, setImgList] = useState(null)
  const allImgList = useRef(0)
  const[ImageSearch, setImageSearch] = useState("")
  const [pageIndex, setPageIndex] = useState(1)

  useEffect(() => {
    async function fetchPosts(){
      const postList = await fetch(`https://ai-image-backend.netlify.app/.netlify/functions/api/get`,{
        headers:{'Access-Control-Allow-Origin': '*'}
      })
      const data = await postList.json() 
      allImgList.current = data.posts

      setImages(data.posts.length)
      setImgList(data.posts.reverse().slice(0,(images < 16) ? images: 16))
    }
    fetchPosts()
  },[])

  const changePage = (page, pageSize) => {
    setPageIndex(page)
    setImgList(allImgList.current.filter((img) => img.prompt.search(ImageSearch) != -1).slice(16*(page-1),(16*(page-1) + 16) > images ? images  : 16*(page-1) + 16))
  }

  const filteredSearch = async (e)=>{
    setImageSearch(e.target.value)
    const fileteredImages = allImgList.current.filter((img) => img.prompt.search(e.target.value) != -1)
    setImages(fileteredImages.length)
    setImgList(fileteredImages.slice(0,(fileteredImages.length < 16) ? fileteredImages.length : 16))
    setPageIndex(1)
  }

  return (
    <div className='bg-[#f9fafe] min-h-screen border border-t-slate-200'>
        <div className='pt-8 w-11/12 mx-auto max-w-7xl'>
            <h1 className='font-bold text-3xl'>The Community Showcase</h1>
            <p className='text-slate-500 mt-2'>Browse through a collection of imaginative and visually stunning images generated by DALL-E-AL</p>
        </div>
        <form className='pt-8 w-11/12 mx-auto max-w-7xl'>
          <label>Search posts</label><br/>
          <input name='text-area' className='border border-slate-400 w-full rounded text-sm p-2 mt-2 focus:outline-none text-slate-500' value={ImageSearch} onChange={filteredSearch} placeholder='Search Something..'/>
        </form>
        {!imgList ? <img src={loader} className="w-8 sm:w-10 md:w-14 xl:w-20 mx-auto mt-8"/>:<div className='pt-8 w-11/12 mx-auto grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 max-w-7xl grid-cols-1'>
          {imgList.map((img) => <ShowCase key={img._id} _id={img._id} photo={img.photo} name={img.name} prompt={img.prompt}/>)}
        </div>}
        <div className='my-4 sm:w-11/12 w-full mx-auto max-w-7xl flex justify-center'>
          <Pagination current={pageIndex} total={images} onChange={changePage} defaultPageSize={16}/>
        </div>
    </div>
  )
}

export default Home
